<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>蜗牛的博客</title>
<meta name="description" content="记录下" />
<link rel="shortcut icon" href="https://yangyng.github.io/favicon.ico?v=1568777792274">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link href="https://cdn.remixicon.com/releases/v1.3.1/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css">

<link rel="stylesheet" href="https://yangyng.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="蜗牛的博客 - Atom Feed" href="https://yangyng.github.io/atom.xml">



  </head>
  <body>
    <div id="app" class="main px-4 flex flex-col lg:flex-row">
      <div id="sidebar" class="sidebar-wrapper lg:static lg:w-1/4">
  <div class="lg:sticky top-0">
    <div class="sidebar-content">
      <div class="flex lg:block p-4 lg:px-0 items-center fixed lg:static lg:block top-0 right-0 left-0 bg-white z-50">
        <i class="remixicon-menu-2-line lg:mt-4 text-2xl cursor-pointer animated fadeIn" onclick="openMenu()"></i>
        <a href="https://yangyng.github.io">
          <img class="animated fadeInLeft avatar rounded-lg mx-4 lg:mt-32 lg:mx-0 mt-0 lg:w-24 lg:h-24 w-12 w-12" src="https://yangyng.github.io/images/avatar.png?v=1568777792274" alt="">
        </a>
        <h1 class="animated fadeInLeft lg:text-4xl font-extrabold lg:mt-8 mt-0 text-xl" style="animation-delay: 0.2s">蜗牛的博客</h1>
      </div>
      
        <div class="animated fadeInLeft" style="animation-delay: 0.4s">
          <p class="my-4 text-gray-600 font-light hidden lg:block">
            文章目录
          </p>
          <div class="toc-container hidden lg:block">
            <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#%E6%9C%AC%E6%96%87%E4%B8%BB%E8%A6%81%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%BA%9Bmq%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E7%9A%84%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8">本文主要介绍一些MQ的基础概念,以及简单的安装使用</a></li>
</ul>
</li>
<li><a href="#rabbit-mq-windows-%E5%AE%89%E8%A3%85-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">rabbit mq windows 安装 注意事项</a>
<ul>
<li><a href="#erlang-%E5%AE%89%E8%A3%85">erlang 安装</a></li>
<li><a href="#rabbit-mq-%E5%AE%89%E8%A3%85">rabbit mq 安装</a></li>
<li><a href="#rabbit-mq-%E4%BD%BF%E7%94%A8">rabbit mq 使用</a></li>
<li><a href="#%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86%E7%AE%80%E4%BB%8B">基本知识简介</a></li>
<li><a href="#queue">queue</a>
<ul>
<li><a href="#message-acknowledgment">Message acknowledgment</a></li>
<li><a href="#prefetch-count">Prefetch count</a></li>
<li><a href="#%E5%A3%B0%E6%98%8Equeue">声明Queue</a></li>
<li><a href="#%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99">路由规则</a></li>
<li><a href="#%E6%B6%88%E8%B4%B9%E8%80%85%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF">消费者订阅消息</a></li>
<li><a href="#%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4">生产者消息确认</a></li>
<li><a href="#%E6%B6%88%E6%81%AF%E7%9A%84%E6%B6%88%E8%B4%B9">消息的消费</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      
    </div>
  </div>
</div>

<div class="menu-container">
  <i class="remixicon-arrow-left-line text-2xl cursor-pointer animated fadeIn close-menu-btn" onclick="closeMenu()"></i>
  <div>
    
      
        <a href="/" class="menu" style="animation-delay: 0s">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu" style="animation-delay: 0.2s">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu" style="animation-delay: 0.4s">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu" style="animation-delay: 0.6000000000000001s">
          关于
        </a>
      
    
  </div>
  <div class="site-footer">
    <div class="py-4 text-gray-700"></div>
    <a class="rss" href="https://yangyng.github.io/atom.xml" target="_blank">RSS</a>
  </div>
</div>
<div class="mask" onclick="closeMenu()">
</div>
      <div class="content-wrapper py-32 lg:p-8 lg:w-3/4 post-detail animated fadeIn">
        <h1 class="text-3xl font-bold lg:mt-16">如何使用RabbitMQ的一点小总结</h1>
        <div class="text-sm text-gray-700 lg:my-8">
          2019-06-17 / 2 min read
        </div>
        
          <img class="post-feature-image rounded-lg mx-auto my-4" src="https://yangyng.github.io/post-images/mS0iMd-bJ.jpg" alt="">
        
        <div class="post-content yue">
          <h3 id="本文主要介绍一些mq的基础概念以及简单的安装使用">本文主要介绍一些MQ的基础概念,以及简单的安装使用</h3>
<!-- more -->
<h2 id="rabbit-mq-windows-安装-注意事项">rabbit mq windows 安装 注意事项</h2>
<h3 id="erlang-安装">erlang 安装</h3>
<p><strong>下载地址</strong></p>
<p><a href="http://www.erlang.org/downloads" title="erlang 下载路径">http://www.erlang.org/downloads</a></p>
<p><strong>环境变量配置</strong> <code>ERLANG_HOME 安装路径</code></p>
<p><strong>注意事项</strong><br>
安装erlang 时注意 一致</p>
<pre><code>C:\Windows\System32\config\systemprofile\.erlang.cookie

C:\Users\用户名\.erlang.cookie
</code></pre>
<hr>
<h3 id="rabbit-mq-安装">rabbit mq 安装</h3>
<p><strong>下载地址</strong></p>
<p><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.7.5" title="rabbit mq下载路径">https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.7.5</a></p>
<p>出现失败时</p>
<pre><code>rabbit-service start 启动服务
rabbit-service stop 关闭服务
rabbit-service remove 移除服务
rabbitmq-plugins enable rabbitmq_management 安装页面管理工具
</code></pre>
<hr>
<h3 id="rabbit-mq-使用">rabbit mq 使用</h3>
<pre><code>//获取连接
ConnectionFactory connectionFactory = new ConnectionFactory();
//地址
connectionFactory.setHost(&quot;127.0.0.1&quot;);
//端口号
connectionFactory.setPort(5672);
//用户名
connectionFactory.setUserName(&quot;guest&quot;);
//密码
connectionFactory.setPassword(&quot;guest&quot;);
//获取连接
Connection connection = connectionFactory.getConnection();
//获取通道
Channel channel = connection.getChannel();
//test 队列名称
channel.queueDeclare(&quot;test&quot;,false,false,false,null);
//消息
String message = &quot;this is a test message&quot;;
//发送消息
channel.basicPublish(&quot;&quot;,&quot;test&quot;,null,message.getBytes());
//关闭频道 关闭连接
channel.close();
connection.close();
</code></pre>
<hr>
<h3 id="基本知识简介">基本知识简介</h3>
<ol>
<li>ConnectionFactory 用来获取连接</li>
<li>connection rabbitMq的socket连接,丰庄路socket协议相关部分逻辑</li>
<li>channel用来定义Queue(队列)定义Exchange(交换机)绑定Queue与Exchange 发布消息等操作</li>
</ol>
<h3 id="queue">queue</h3>
<p>rabbitMq的内部对象 用来存储消息</p>
<h4 id="message-acknowledgment">Message acknowledgment</h4>
<p>消息确认机制</p>
<pre><code>mq在收到消息回执时将消息从queue中移除,如果没有收到回执,并检测到消费者的rabbitmq连接断开,会将消息发送给其它消费者(如果存在多个消费者)处理
</code></pre>
<p>开发过程注意</p>
<pre><code>处理完业务逻辑后,没有发送回执给RabbitMQ,会导致Queue中的消息越来越多,消费者重启后出现消息的重复消费问题
</code></pre>
<p>消息的持久化以及消息的事务性</p>
<h4 id="prefetch-count">Prefetch count</h4>
<p>可以设置该参数控制发给每个消费者的消息数.<img src="http://ostest.qiniudn.com/wordpress/wp-content/uploads/2014/02/2014-2-21-9-49-08.png" alt="Prefetch count">比如我们设置prefetchCount=1，则Queue每次给每个消费者发送一条消息；消费者处理完这条消息后Queue会再给该消费者发送一条消息。</p>
<h4 id="声明queue">声明Queue</h4>
<ul>
<li>
<p>消费者无法订阅或者获取不存在的Queue中的信息</p>
</li>
<li>
<p>消息被Exchange接受之后,如果没有匹配的Queue,会被丢弃</p>
<p>无论是消费者还是生产者,在使用时,即发送或者接受消息是,去尝试建立消息队列,因为加入客户端去尝试创建一个已经存在的消息队列时,是不会做任何操作,并返回成功.</p>
<p>一个消费者在一个信道中正在监听一个队列的消息时,不允许该消费者在同一个channel中声明其它队列</p>
</li>
</ul>
<p>声明方式 queue.declare</p>
<ul>
<li>
<p><strong>Exclusive 排他队列</strong></p>
<p>该队列仅对首次声明它的连接可见,并在连接断开时自动删除.</p>
<p>1.排他队列是基于连接可见的,同一连接的不同信道可以同时访问同一个连接创建的排他队列</p>
<p>2.一个连接已经声明了一个排他队列,其它连接不允许建立同名的排他队列.</p>
<p>3.即使设置该队列是持久化的,一旦连接关闭或者客户端退出,该排他队列都会被自动删除.</p>
</li>
<li>
<p><strong>Auto-delete 自动删除</strong> 适用于临时队列</p>
</li>
<li>
<p><strong>durable持久化</strong> 在连接断开或者客户端重启后仍会存活</p>
</li>
</ul>
<p><strong>总结</strong></p>
<pre><code>存活周期仅限于当前连接
自动删除的特性
仅能创建一次
</code></pre>
<hr>
<h4 id="路由规则">路由规则</h4>
<ul>
<li><strong>direct 路由规则完全相同 <em>exp:</em> ==</strong></li>
<li><strong>topic 模糊匹配路由规则 <em>exp:</em> like</strong></li>
<li><strong>fanout 发布与订阅方式</strong></li>
</ul>
<h4 id="消费者订阅消息">消费者订阅消息</h4>
<ul>
<li>
<p><strong>basic.consume</strong></p>
<p>订阅某队列中的消息后,channel自动在处理完上一条消息后,接受下一条消息.(同一个channel中消息处理是并行的)除非关闭channel或者取消订阅,否则客户端将会一直接收队列的消息.</p>
</li>
<li>
<p><strong>basic.get</strong></p>
<p>主动获取队列中的消息,但是不可以通过循环调用basic.get来代替basic.consume,basic,get在实际执行的时候,首先consume某一队列,然后检索第一条消息,然后在取消订阅,在高吞吐量的消费者,最好使用第一种方式</p>
</li>
</ul>
<p>多个消费者同时订阅同一个队列,RabbitMQ是采用循环的方式分发消息的,每一条消息只能被一个订阅者接收.消费者在接到消息时,需要给服务器发送一套确认命令,可以在HandelDelivery中调用basic.ack实现,也可以在consume某个队列时,设置autoACK属性为true.如果消费者在接到消息以后还没来得及返回ACK就断开了连接,消息服务器会重传该消息给下一个订阅者,没有订阅者就会存储该消息.</p>
<hr>
<h4 id="生产者消息确认">生产者消息确认</h4>
<ol>
<li>
<p>事务机制</p>
<pre><code> Channel channel = getChannel();

 //将信道置为 publisher confirm 模式
 try {
     channel.txSelect();
     channel.basicPublish(&quot;TEST_DIRECT_EXCHANGE&quot;, &quot;TEST_QUEUE&quot;,
             null, &quot;this is a test msg&quot;.getBytes());
     int result = 1 / 0;
     channel.txCommit();
 } catch (IOException e) {
     channel.txRollback();
     channel.close();
 }
</code></pre>
</li>
<li>
<p>发送方确认机制</p>
<p>Channel channel = getChannel();</p>
<pre><code> //将信道置为 publisher confirm 模式
 channel.confirmSelect();

 channel.basicPublish(&quot;TEST_DIRECT_EXCHANGE&quot;, &quot;TEST_QUEUE&quot;,
         null, &quot;this is a test msg&quot;.getBytes());

 if (channel.waitForConfirms()) {
     System.out.println(&quot;msg send failure %n hhh&quot;);
 }

 channel.close();
</code></pre>
</li>
<li>
<p>批量confirm</p>
</li>
<li>
<p>异步confirm</p>
</li>
</ol>
<p><strong>QPS</strong></p>
<p><strong>异步confirm 支持的峰值最高</strong></p>
<p><strong>均值 异步与批量相差不多 大约是其他两种的五到六倍</strong></p>
<p><strong>均值 普通confirm 比事务方式略高</strong></p>
<h4 id="消息的消费">消息的消费</h4>
<p>对于同一个消息队列 如果拥有多个消费者时 队列收到的消息将以轮询的分发方式发送给消费者</p>

        </div>

        


        <div class="flex justify-between py-8">
          
            <div class="prev-post">
              <a href="https://yangyng.github.io/post/rcmQSI3Yq">
                <h3 class="post-title">
                  <i class="remixicon-arrow-left-line"></i>
                   Redis 常用配置项
                </h3>
              </a>
            </div>
          

          
            <div class="next-post">
              <a href="https://yangyng.github.io/post/8doV_ak0A">
                <h3 class="post-title">
                  RabbitMQ 使用延迟队列的一点代码
                  <i class="remixicon-arrow-right-line"></i>
                </h3>
              </a>
            </div>
          
        </div>

        
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: 'ca87020cd4c0c4370aff',
    clientSecret: '6c3acfe05574181b683ff672b82cbd4310ff6b78',
    repo: 'yangyng.github.io',
    owner: 'yangyng',
    admin: ['yangyng'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

          

          
        

      </div>
    </div>

    <script src="https://yangyng.github.io/media/prism.js"></script>  
<script>

Prism.highlightAll()

let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

// This should probably be throttled.
// Especially because it triggers during smooth scrolling.
// https://lodash.com/docs/4.17.10#throttle
// You could do like...
// window.addEventListener("scroll", () => {
//    _.throttle(doThatStuff, 100);
// });
// Only not doing it here to keep this Pen dependency-free.

window.addEventListener("scroll", event => {
  let fromTop = window.scrollY;

  mainNavLinks.forEach((link, index) => {
    let section = document.getElementById(decodeURI(link.hash).substring(1));
    let nextSection = null
    if (mainNavLinks[index + 1]) {
      nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
    }
    if (section.offsetTop <= fromTop) {
      if (nextSection) {
        if (nextSection.offsetTop > fromTop) {
          link.classList.add("current");
        } else {
          link.classList.remove("current");    
        }
      } else {
        link.classList.add("current");
      }
    } else {
      link.classList.remove("current");
    }
  });
});


document.addEventListener("DOMContentLoaded", function() {
  var lazyImages = [].slice.call(document.querySelectorAll(".post-feature-image.lazy"));

  if ("IntersectionObserver" in window) {
    let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          let lazyImage = entry.target
          lazyImage.style.backgroundImage = `url(${lazyImage.dataset.bg})`
          lazyImage.classList.remove("lazy")
          lazyImageObserver.unobserve(lazyImage)
        }
      });
    });

    lazyImages.forEach(function(lazyImage) {
      lazyImageObserver.observe(lazyImage)
    })
  } else {
    // Possibly fall back to a more compatible method here
  }
});

const menuContainer = document.querySelector('.menu-container')
const menus = document.querySelectorAll('.menu-container .menu')
const mask = document.querySelector('.mask')
const contentWrapper = document.querySelector('.content-wrapper')
const latestArticle = document.querySelector('.latest-article')
const readMore = document.querySelector('.read-more')
const indexPage = document.querySelector('.index-page')

const isHome = location.pathname === '/'
if (latestArticle) {
  latestArticle.style.display = isHome ? 'block' : 'none'
  readMore.style.display = isHome ? 'block' : 'none'
  indexPage.style.display = isHome ? 'none' : 'block'
}

const openMenu = () => {
  menuContainer.classList.add('open')
  menus.forEach(menu => {
    menu.classList.add('animated', 'fadeInLeft')
  })
  mask.classList.add('open')
  contentWrapper.classList.add('is-second')
}

const closeMenu = () => {
  menuContainer.classList.remove('open')
  menus.forEach(menu => {
    menu.classList.remove('animated', 'fadeInLeft')
  })
  mask.classList.remove('open')
  contentWrapper.classList.remove('is-second')
}
</script>
  
  </body>
</html>
